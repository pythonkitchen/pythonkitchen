<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    a {
	word-wrap: break-word !important;
}
  </style>
  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>

<!-- and it's easy to individually load additional languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>

<link rel="stylesheet" href="/post.css"> 

</head>
<body class="bg-gray-50">

<nav class="bg-white border-gray-200 dark:bg-gray-900">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="/" class="flex items-center">
          <img src="https://www.pythonkitchen.com/wp-content/uploads/2022/11/cropped-p3-50x50.png" class="h-8 mr-3" alt="PythonKitchen Logo" />
          <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">PythonKitchen</span>
      </a>
      <button data-collapse-toggle="navbar-default" type="button" class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
          <span class="sr-only">Open main menu</span>
          <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 17 14">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h15M1 7h15M1 13h15"/>
          </svg>
      </button>
      <div class="hidden w-full md:block md:w-auto" id="navbar-default">
        <ul class="font-medium flex flex-col p-4 md:p-0 mt-4 border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li>
            <a href="/" 
            class="block py-2 pl-3 pr-4 text-white bg-blue-700 rounded md:bg-transparent md:text-blue-700 md:p-0 dark:text-white md:dark:text-blue-500" aria-current="page">
            Home</a>
          </li>
          <li>
            <a href="https://github.com/pythonkitchen/pythonkitchen/tree/source/data/posts" class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
              Write</a>
          </li>
          <li>
            <a href="https://forms.gle/gf1p1Aitw9M9m8Zy5" class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
              Contact</a>
          </li>
          <!-- <li>
            <a href="#" class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Pricing</a>
          </li>
          <li>
            <a href="#" class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:p-0 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">Contact</a>
          </li> -->
        </ul>
      </div>
    </div>
  </nav>
  
  

<div class="p-8">

</div>

<div class="flex flex-row space-x-2">
    <div class="basis-3/4">
        <div class="p-8 pl-12">
            <div class="ml-2">
                <div class=" p-12 bg-white rounded-lg shadow-lg">
                    <p class="text-3xl" style="font-weight: 600;">DSL / Python / New Language: How to build a CSS pre-processor (like SASS) from scratch (DotDot)</p>
                    <br>
                    <div class="flex items-center gap-x-4 text-xs">
                        <time datetime="2019-07-18 15:02:53" class="text-gray-500">July 18, 2019</time>
                        
                        <a href="#" class="relative z-10 rounded-full bg-gray-50 px-3 py-1.5 font-medium text-gray-600 hover:bg-gray-100">
                            compiler theory
                        </a>
                        
                    </div>
                    
                        <div class="relative mt-8 flex items-center gap-x-4">
                            <img src="https://github.com/Abdur-rahmaanJ.png?size=200" alt="" class="h-10 w-10 rounded-full bg-gray-50">
                            <div class="text-sm leading-6">
                            <p class="font-semibold text-gray-900">
                                <a href="#">
                                <span class="absolute inset-0"></span>
                                Abdur-Rahmaan Janhangeer
                                </a>
                            </p>
                            <p class="text-gray-600">Chef</p>
                            </div>
                        </div>
                    
                    <br>
                    <article>
                        <p>If you are in web development, maybe you&rsquo;ve heard of <a href="https://sass-lang.com/documentation/syntax/comments">Sass</a>, <a href="http://lesscss.org">Less</a>, Pug, <a href="http://stylus-lang.com">Stylus</a> etc. All these are pre-processors. In this tutorial we&rsquo;re going to build nothing less than a functional css pre-processor from scratch with variables and functions. This type of new language is called source-to-source compiled. If you are thrilled, i hope not to disappoint you.</p>
<p><img alt="Mesh drilling" src="https://images.unsplash.com/photo-1516562309708-05f3b2b2c238?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=334&amp;q=80" /></p>
<h3>Charting The Routes</h3>
<p>First let&rsquo;s see what we&rsquo;ll be doing. We&rsquo;ll call the language DotDot with extention .dot</p>
<p>When designing a new language, it&rsquo;s good to spend sometimes on design. If you have something that really flows, you can start coding.</p>
<p>Here is a DotDot snippet:</p>
<pre><code class="language-python">
x = 1
y = 5
x-y-z = 6
col-z = berry

@f{
    border: 10px solid black;
    border-radius: 50%;
}

.add{
    color:white;
    background-color: rgb(3, 4, 5);
}

#ad{
    color: rgb(x, 4, 5);
}

.a div a{
    color: ..col-z;
    @f
}

</code></pre>
<p>which compiles to this:</p>
<pre><code class="language-python">
.add{
    color: white;
    background-color: rgb(3,4,5);
}

#ad{
    color: rgb(1,4,5);
}

.a div a{
    color: berry;
    border: 10px solid black;
    border-radius: 50%;
}

</code></pre>
<h3>Dissecting Design</h3>
<p>Let&rsquo;s see what features we included</p>
<h4><strong>Variables</strong></h4>
<pre><code class="language-python">
x = 1
y = 5
x-y-z = 6
col-z = berry

</code></pre>
<p>We see that </p>
<ul>
<li>we don&rsquo;t need to specify a specifier like $ or var in Js.</li>
<li>we can add - in the variable name</li>
</ul>
<p>We can call variables in function values</p>
<pre><code class="language-python">
rgb(x, 4, 5);

</code></pre>
<p>And in attribute values</p>
<pre><code class="language-python">
color: ..col-z;

</code></pre>
<p>Where .. denotes a variable call in attribute directly.</p>
<h4><strong>Functions</strong></h4>
<pre><code class="language-python">
@f{
    border: 10px solid black;
    border-radius: 50%;
}

</code></pre>
<p>Functions are denoted by an @ sign. These are called as in the following case where it expands into the properties it contains</p>
<pre><code class="language-python">
.a div a{
    color: ..col-z;
    @f
}

</code></pre>
<p>That is enough complexity to deal with. Let&rsquo;s start!</p>
<pre><code class="language-python">import copy # we have just one import
</code></pre>
<p>We also add our source as a variable</p>
<pre><code class="language-python">source = '''

x = 1
y = 5
x-y-z = 6
col-z = berry

@f{
    border: 10px solid black;
    border-radius: 50%;
}

.add{
    color:white;
    background-color: rgb(3, 4, 5);
}

#ad{
    color: rgb(x, 4, 5);
}

.a div a{
    color: ..col-z;
    @f
}
'''
</code></pre>
<h3>Defining Constants</h3>
<p>We&rsquo;ve bundled our constants in a class.</p>
<pre><code class="language-python">
class SYM:
    LEFT_BRACE = '{'
    RIGHT_BRACE = '}'
    LEFT_ROUND = '('
    RIGHT_ROUND = ')'
    NEW_LINE = '\n'
    TAB = '    '
    COLON = ':'
    SEMI_COLON = ';'
    SPACE = ' '
    COMMA = ','
    EQUAL = '='
    UNION = '-'
    DOT = '.'
    AT = '@'

</code></pre>
<p>We then define our keywords</p>
<pre><code class="language-python">
KEYWORDS = (SYM.LEFT_BRACE, SYM.RIGHT_BRACE, SYM.NEW_LINE, SYM.TAB, SYM.COLON, 
    SYM.SEMI_COLON, SYM.SPACE, SYM.RIGHT_ROUND, SYM.LEFT_ROUND, SYM.COMMA, SYM.EQUAL)

</code></pre>
<h3>Building the Lexer</h3>
<p>The code for the lexer is from our <a href="https://www.pythonmembers.club/2018/05/01/building-a-lexer-in-python-tutorial/">lexer tutorial</a>. Please go over it if you feel the need to. Here we converted the code into a class with a get_lexeme method. The metho gives us a list. The dotdot snippet above gets converted to the list held in lexemes variable below.</p>
<p>Here is our lexer class:</p>
<pre><code class="language-python">
class Lexer:
    def __init__(self, source: str, KEYWORDS: list):
        self.white_space = SYM.SPACE
        self.KEYWORDS = KEYWORDS
        self.lexeme = ''
        self.lexemes = []
        self.string = source

    def get_lexemes(self) -&gt; list:
        for i, char in enumerate(self.string):
            if char != self.white_space and char != SYM.NEW_LINE:
                self.lexeme += char  # adding a char each time
            if (i+1 &lt; len(self.string)):  # prevents error
                if self.string[i+1] == self.white_space or self.string[i+1] in KEYWORDS or self.lexeme in KEYWORDS or self.string[i+1] == SYM.NEW_LINE: # if next char == ' '
                    if self.lexeme != '':
                        self.lexemes.append(self.lexeme)
                        self.lexeme = ''
        return self.lexemes

</code></pre>
<p>Then we declare our basic variables:</p>
<pre><code class="language-python">
v = Lexer(source, KEYWORDS)
lexemes = v.get_lexemes()

lexemes.append('') # appending an unused last element to properly dump all values

</code></pre>
<p>lexemes is now equal to</p>
<pre><code class="language-python">
['x', '=', '1', 'y', '=', '5', 'x-y-z', '=', '6', 'col-z', 
'=', 'berry', '@f', '{', 'border', ':', '10px', 'solid', 
'black', ';', 'border-radius', ':', '50%', ';', '}', '.add', 
'{', 'color', ':', 'white', ';', 'background-color', ':', 
'rgb', '(', '3', ',', '4', ',', '5', ')', ';', '}', '#ad', 
'{', 'color', ':', 'rgb','(', 'x', ',', '4', ',', '5', ')', 
';', '}', '.a', 'div', 'a', '{', 'color', ':', '..col-z', 
';', '@f', '}', '']

</code></pre>
<p>With such separated data, it&rsquo;s much easier to proceed!</p>
<h3>The Concept of Memory</h3>
<p>Next we define a dictionary to hold all our variables.</p>
<pre><code class="language-python">
memory = {}

</code></pre>
<p>where </p>
<pre><code class="language-python">
x = 1

</code></pre>
<p>will become this later on:</p>
<pre><code class="language-python">
{'x':'1'}

</code></pre>
<p>to retrieve it we&rsquo;ll just do </p>
<pre><code class="language-python">
memory['x']

</code></pre>
<h3>The Concept of Tree</h3>
<p>We&rsquo;ll have a dictionary called tree</p>
<pre><code class="language-python">
tree = {}

</code></pre>
<p>which will hold the converted code as</p>
<pre><code class="language-python">
{
    '@f': {
        'border': '10px solid black', 
        'border-radius': '50%'
    }, 
    '.add': {
        'color':'white', 
        'background-color': 'rgb ( 3 , 4 , 5 )'
    }, '#ad': {
        'color': 'rgb ( x ,4 , 5 )'
    }, 
    '.a div a': {
        'color': '..col-z', 
        '@f': ''
    }
}

</code></pre>
<p>Our next step will exactly be this: converting the lexemes list into this dictionary</p>
<h3>Generating The Tree</h3>
<p>To keep track of where we are, we&rsquo;ll have a series of variables taking True/False values (on/off)</p>
<h4>Setting up holders</h4>
<pre><code class="language-python">
id_string = ''
last_id_string = ''
last_attribute = ''

current_attribute = ''
current_value = ''

len_lexemes = len(lexemes)

</code></pre>
<p>id string will hold like #add, .x a div etc</p>
<p>the last_ variables just hold variables that are not emptied upon leaving the sub section</p>
<h4>Setting up flags</h4>
<p>We&rsquo;ll have 3 flags.</p>
<p>One when we are starting a block, which will become true when encountering a { and false when encountering a }</p>
<p>An attribute is color in color:black;</p>
<p>The attribute ongoing will become true when passing over { and ; and will become false when passing over :</p>
<p>value_ongoing will become true when going over : and false when going over ;</p>
<pre><code class="language-python">
block_ongoing = False
attribute_ongoing = False
value_ongoing = False

</code></pre>
<p>We&rsquo;ll start looping over the list and implement what we described of the flags above</p>
<pre><code class="language-python">
for i, lex in enumerate(lexemes):

    if i+1 &lt; len_lexemes:
        next_lexeme = lexemes[i+1]
    prev_lexeme = lexemes[i-1]

    if lex == SYM.LEFT_BRACE:
        block_ongoing = True
        attribute_ongoing = True
        continue
    elif lex == SYM.RIGHT_BRACE:
        block_ongoing = False
        statement_ongoing = False
        attribute_ongoing = False
        value_ongoing = False
        continue
    if lex == SYM.COLON:
        value_ongoing = True
        attribute_ongoing = False
        continue
    elif lex == SYM.SEMI_COLON:
        value_ongoing = False
        statement_ongoing = False
        attribute_ongoing = True
        continue

</code></pre>
<p>Continue is needed as once we have activated a flag, we have no work to do, we move on.</p>
<h3>Dealing with variables</h3>
<p>To assign variables, we just wait for the = sign then continue.</p>
<p>Then when going over a variable name or a value we just prevent the loop from continuing by using continue</p>
<pre><code class="language-python">
    if lex == SYM.EQUAL:
        memory[prev_lexeme] = next_lexeme
        continue
    elif next_lexeme == SYM.EQUAL or prev_lexeme == SYM.EQUAL:
        continue

</code></pre>
<h3>Where The Tree Builds</h3>
<p>Now we&rsquo;ll make use of the flags</p>
<pre><code class="language-python">
    if not block_ongoing:
        id_string += lex + ' '
    elif block_ongoing:
        if id_string:
            tree[id_string.strip()] = {}
            last_id_string = id_string.strip()
            id_string = ''

</code></pre>
<p>Here we are dealing with the block id, example #add in #add {}. We did </p>
<pre><code class="language-python">
tree[id_string.strip()] = {}

</code></pre>
<p>here is an example tree at this point</p>
<pre><code class="language-python">
{
'.add': {}
}

</code></pre>
<p>Using the same principle, we&rsquo;ll do so for the attribute</p>
<pre><code class="language-python">
    if attribute_ongoing:
        current_attribute += lex
    elif not attribute_ongoing:
        if current_attribute:
            tree[last_id_string][current_attribute] = ''
            last_attribute = current_attribute
            current_attribute = ''

</code></pre>
<p>Here is an example tree at this point</p>
<pre><code class="language-python">
{
'.add': {
        'color':''
    }
}

</code></pre>
<p>and value</p>
<pre><code class="language-python">    if value_ongoing:
        current_value += lex + ' '
    elif not value_ongoing:
        if current_value:
            tree[last_id_string][last_attribute] = current_value.strip()
            last_value = current_value.strip()
            current_value = ''
</code></pre>
<p>Here is an example tree at this point</p>
<pre><code class="language-python">
{
'.add': {
        'color':'white'
    }
}

</code></pre>
<p>That snippet ends our tree-building block</p>
<h3>Replacing Values</h3>
<p>Now let us see how to replace variable names in functions like rgb() and rgba()</p>
<pre><code class="language-python">
def parseFunc(f):
    v = f.split(SYM.LEFT_ROUND)
    name = v[0]
    vals = v[1][:-1].replace(SYM.SPACE, '')
    values = vals.split(SYM.COMMA)
    for i, v in enumerate(values):
        if not v.isnumeric():
            values[i] = memory[v]
    return '{}({})'.format(name.strip(), ','.join(values))

</code></pre>
<p>Here we replace rgb(x, 4, 5) to rgb(1, 4, 5) by replacing the x by 1 in the memory dictionary. To build a CSS pre-processor from scratch, we have to take all cases, which we&rsquo;ll do after.</p>
<h3>Transforming The Tree Into It&rsquo;s Final Form</h3>
<p>Now we need to pass over the tree once again and expand functions, replace values, including the use of our defined function above.</p>
<p>Technically we can&rsquo;t change a dictionary while iterating over it. We have to copy it to break references to it. We have to deepcopy it.</p>
<pre><code class="language-python">
ntree = copy.deepcopy(tree)

</code></pre>
<pre><code class="language-python">
for block_name in ntree:
    properties = ntree[block_name]
    if block_name[0] == SYM.AT:
        continue

</code></pre>
<p>Now, if we get the first symbol of the id as a @, we just skip it as we don&rsquo;t need to expand the definition.</p>
<pre><code class="language-python">
    for element in properties:
        value = properties[element]
        if SYM.LEFT_ROUND in value:
            tree[block_name][element] = parseFunc(value)

</code></pre>
<p>Next we say if there is a ( in the value, it denotes a function like rgb(). In that case we use our function parseFunc.</p>
<pre><code class="language-python">
        if SYM.DOT in value:
            tree[block_name][element] = memory[value.strip(SYM.DOT)]

</code></pre>
<p>Next we see a . in the value, we go see in the memory dictionary and replace it</p>
<pre><code class="language-python">
        if SYM.AT in element:
            del tree[block_name][element]
            tree[block_name].update(tree[element])

</code></pre>
<p>Next we we see the @ symbol in as key in a block, we just add the dictionaries in it to the dictionaries in that block (Done by update in Python) .</p>
<p>That also shows the advantage of using a data structure over plain strings.</p>
<h3>Compiling To Normal Css</h3>
<p>Now we can compile it to normal CSS, we&rsquo;ll just print it for now (you can file= in print btw)</p>
<pre><code class="language-python">
for key in tree:
    if key[0] == SYM.AT:
        continue
    print(key, '{', sep='')
    for elem in tree[key]:
        print('{}{}: {};'.format(SYM.TAB, elem, tree[key][elem]))
    print('}\n')

</code></pre>
<p>which produces</p>
<pre><code class="language-python">
.add{
    color: white;
    background-color: rgb(3,4,5);
}

#ad{
    color: rgb(1,4,5);
}

.a div a{
    color: berry;
    border: 10px solid black;
    border-radius: 50%;
}


</code></pre>
<h3>The Future of It</h3>
<p>This was done without a safety net and lacking lot of cool features but it is done to demonstrate that with some normal programming logic, you can set up something cool. It was my usual linkedIn Project of The Week.</p>
<p>If you want to build a CSS pre-processor from scratch based on indentation (like stylus), use <a href="https://www.pythonmembers.club/2018/05/04/building-an-indentation-analyser-in-python-tutorial/">this tutorial</a>.</p>
<p>Github Link: <a href="https://github.com/Abdur-rahmaanJ/dotdot">https://github.com/Abdur-rahmaanJ/dotdot</a></p>
<p>Pictures from unsplash.</p>
<p>&ndash; Abdur-Rahmaan Janhangeer</p>

                        <script src="https://utteranc.es/client.js"
        repo="pythonkitchen/blog-comments"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
                    </article>
                
                  </div>
                
            </div>
        </div>
        
    </div>
    <div class="basis-1/4"></div>
  </div>




<script>hljs.highlightAll();</script>




</body>
</html>